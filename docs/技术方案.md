# SentinelMask 技术方案（V0.2 / MVP）

## 1. 目标与范围

### 1.1 目标

1. 在发送前统一拦截用户输入，执行敏感信息检测与脱敏。
2. 默认离线处理，不上传原文或未脱敏命中值。
3. 在 Chrome / Edge / Firefox 保持一致行为与可验证性。

### 1.2 MVP 范围

1. 站点：`chatgpt.com`、`chat.openai.com`、`claude.ai`、`gemini.google.com`、`chat.deepseek.com`。
2. 规则：姓名（仅提示）、手机号、银行卡、邮箱、常见 API Key。
3. 流程：`preSendGuard` 拦截、检测、脱敏、确认、回写、发送。
4. 设置：规则开关、脱敏策略、自定义规则、白名单、日志与清理。

### 1.3 非范围（MVP 不做）

1. 附件、截图、语音输入通道的敏感信息检测。
2. 语义模型辅助识别（V0.3）。
3. 团队级策略下发与审计（V0.4）。

## 2. 总体架构

## 2.1 模块划分

1. `content/`（内容脚本）
   - 站点适配器（输入框定位、发送按钮定位、事件接入）。
   - 发送拦截器（键盘、点击、submit、程序化触发）。
   - `preSendGuard` 编排器（检测和放行主入口）。
   - 发送前确认 UI（中高风险确认、失败兜底提示）。
2. `core/`（共享核心）
   - 规则引擎（内置规则 + 自定义规则）。
   - 脱敏执行器（全量替换 / 部分保留 / 仅提示）。
   - 风险决策器（低中高策略、白名单、忽略逻辑）。
   - 文本写回器（textarea/contenteditable 抽象）。
3. `background/`（Service Worker）
   - 设置存储读写。
   - 本地日志聚合与淘汰。
   - 规则包更新（签名校验、版本控制、灰度控制）。
4. `options/`（设置页）
   - 规则配置、自定义规则管理、白名单管理、日志查看与清空。
5. `shared/`（公共定义）
   - 类型定义、错误码、版本号、跨模块消息协议。

## 2.2 运行时数据流

1. 内容脚本捕获发送意图。
2. 构造 `PreSendContext`（站点、触发源、输入文本、IME 状态）。
3. 进入 `preSendGuard(context)`。
4. 执行规则检测与脱敏，输出 `GuardResult`。
5. 风险决策：自动放行 / 二次确认 / 强制阻断。
6. 放行路径将脱敏文本回写输入框并触发实际发送。
7. 记录日志（仅类型、次数、时间、动作、来源，不含原文）。

## 3. 关键流程设计

## 3.1 preSendGuard 统一网关

`preSendGuard` 是所有发送路径唯一入口，输入和输出如下。

```ts
type SendTrigger = "enter" | "ctrl_enter" | "button_click" | "submit" | "programmatic" | "unknown";

interface PreSendContext {
  site: string;
  trigger: SendTrigger;
  isComposing: boolean;
  rawText: string;
  inputKind: "textarea" | "contenteditable";
}

interface GuardResult {
  maskedText: string;
  riskLevel: "low" | "medium" | "high";
  action: "allow" | "confirm" | "block";
  hits: Array<{ ruleType: string; source: "builtin" | "custom" }>;
  warnings: string[];
}
```

## 3.2 发送路径覆盖策略

1. 键盘路径：监听 `keydown`（捕获阶段），识别 `Enter`、`Ctrl/Cmd+Enter`。
2. 按钮路径：监听发送按钮 `click`，覆盖站点自定义按钮。
3. 表单路径：监听 `submit`，并 patch `requestSubmit` 进入网关。
4. 程序化路径：
   - patch `HTMLFormElement.prototype.submit`。
   - patch `HTMLElement.prototype.click` 并判断目标是否为发送控件。
5. 未知路径：统一映射为 `unknown`，按中风险以上策略处理（先阻断再确认）。

## 3.3 IME 处理

1. `compositionstart` 置 `isComposing=true`，期间不触发发送检查。
2. `compositionend` 置 `isComposing=false`，仅当后续真实发送动作发生时进入网关。
3. 对站点自身快捷键逻辑采取捕获阶段拦截，避免提前透传。

## 3.4 文本回写与发送

1. 对 `textarea` 使用 `value` + input/change 事件同步。
2. 对 `contenteditable` 使用 `Range` 安全替换，保留光标和撤销栈。
3. 回写后触发原发送动作；失败则进入兜底策略并提示用户。

## 4. 规则与脱敏设计

## 4.1 内置规则

1. 手机号：大陆号段规则 + 边界约束。
2. 银行卡：长度与 Luhn 校验组合，降低误报。
3. 邮箱：标准格式规则，避免过宽匹配。
4. API Key：OpenAI / AWS / GitHub 常见模式。
5. 姓名：弱规则，仅提示不默认替换。

## 4.2 自定义规则安全约束

1. 正则长度 `<= 256`，规则总数 `<= 100`。
2. 仅允许 flags：`g`、`i`、`m`、`u`。
3. 保存前执行：
   - 编译检查。
   - 示例文本试运行。
   - 高风险模式静态校验（灾难性回溯特征）。
4. 执行期限制：
   - 单条规则预算 `<= 20ms`（基于 2000 字基线）。
   - 全部自定义规则预算 `<= 80ms`。
5. 超时处理：
   - 终止当前规则或批次。
   - 记录告警并提示“部分规则未执行完成”。

## 4.3 风险决策与动作

1. 低风险：自动替换并提示。
2. 中风险：弹窗确认后发送。
3. 高风险：默认阻断，需手动确认（或策略配置为强阻断）。
4. 最低风险保护：银行卡、API Key 用户配置最低不得低于中风险。

## 5. 隐私与联网策略

## 5.1 数据最小化

1. 本地仅保存命中类型、命中次数、时间戳、处理动作、规则来源。
2. 禁止持久化原文、完整命中值、未脱敏片段。
3. 白名单记录保存脱敏摘要或不可逆指纹。

## 5.2 出站约束

1. 发送检测链路不发网络请求。
2. 规则更新（如启用）仅 HTTPS，且请求不包含用户输入文本。
3. 遥测默认关闭，开启后仅允许元信息（错误码、版本、浏览器）。

## 5.3 可审计验证

1. 提供“网络静默自检”开关，触发 100 次发送回放验证无原文出站。
2. 本地日志导出仅含匿名字段，便于审计。

## 6. Manifest 与权限设计

## 6.1 基本原则

1. 禁止 `<all_urls>`。
2. `host_permissions` 仅白名单域名 + 用户手动添加域名。
3. 默认仅 `https` 生效。

## 6.2 浏览器差异重点

1. MV3 Service Worker 生命周期差异（Firefox 重点验证中断恢复）。
2. `declarativeNetRequest` 能力差异，规则更新逻辑不依赖该能力。
3. 商店包校验差异，分别维护发布脚本与清单。

## 7. 失败兜底设计

## 7.1 触发条件

1. 检测超时。
2. 注入失败。
3. 规则引擎异常。
4. 输入框不可写。

## 7.2 默认行为

1. 低风险：允许发送，显著提示“本次未完成完整检测”。
2. 中风险：默认阻断，用户二次确认后放行。
3. 高风险：强制阻断，不提供一键放行。

## 7.3 连续失败策略

1. 连续 3 次失败提示“当前站点兼容异常”。
2. 引导用户手动提交诊断信息（默认不上传）。

## 8. 里程碑与交付

1. M1（核心链路）
   - 完成 `preSendGuard`、ChatGPT 站点发送路径拦截、基础内置规则。
   - 达到“拦截-检测-脱敏-回写-发送”闭环。
2. M2（配置与安全）
   - 完成设置页、自定义规则安全校验、白名单与日志策略。
3. M3（多站点与跨浏览器）
   - 覆盖 Claude/Gemini/DeepSeek。
   - 通过 Chrome/Edge/Firefox 核心回归。
4. M4（发布准备）
   - 完成隐私声明、差异矩阵、发布包与变更说明。

## 9. 开发约束

1. 核心引擎与页面适配解耦，适配器不可直接写规则逻辑。
2. 所有发送入口必须引用统一网关，不允许旁路发送。
3. 新增规则必须附带测试样本与性能数据。
