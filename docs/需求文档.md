# SentinelMask 浏览器扩展需求文档（V0.2）

## 1. 产品目标

1. 在用户将文本发送到网页版大模型平台前，自动识别并脱敏敏感信息。
2. 默认本地处理，不上传原文到外部服务，降低隐私泄露风险。
3. 在不明显影响输入体验的前提下，实现稳定、可控、可验证的发送前安全检查。
4. 覆盖 Chrome、Edge、Firefox 三类浏览器用户。

## 2. 目标用户

1. 使用 Chrome / Edge / Firefox 浏览器并频繁访问 ChatGPT / Claude / Gemini / DeepSeek 等网页版大模型平台的个人用户。
2. 需要避免将真实身份信息、金融信息、密钥等内容发送给模型的开发者、运营、客服等角色用户。

## 3. 核心场景

1. 用户粘贴或输入文本并触发发送，扩展拦截后完成检测和脱敏再发送。
2. 检测到高风险内容（如 API Key、银行卡号）时，阻止直接发送并要求用户确认。
3. 用户可在发送前预览“原文 vs 脱敏后文本”，确认最终内容。

## 4. 功能需求（MVP）

### 4.1 敏感信息识别类型

1. 真实姓名（弱规则，默认仅提示）。
2. 手机号码（中国大陆为主，可扩展国际格式）。
3. 银行卡号（结合长度和校验规则）。
4. 邮箱地址。
5. API Key（OpenAI / AWS / GitHub 等常见格式）。

### 4.2 脱敏策略

1. 全量替换：例如 `[PHONE]`、`[BANK_CARD]`、`[API_KEY]`。
2. 部分保留：例如手机号 `138****1234`、银行卡仅保留后 4 位。
3. 用户可按类型配置替换策略（全替换/部分替换/仅提示）。

### 4.3 发送拦截

1. 所有发送入口必须进入统一拦截网关（`preSendGuard`）后才能发送。
2. 必须覆盖以下触发路径：
   - `Enter` 发送。
   - `Ctrl+Enter` / `Cmd+Enter` 发送。
   - 页面发送按钮点击（含站点自定义按钮）。
   - 表单 `submit` / `requestSubmit`。
   - 程序触发的 `click` / `submit`（程序化发送）。
3. IME 输入法合成期间（`isComposing=true`）不触发发送检查；在 `compositionend` 后按实际发送动作进入拦截。
4. 对无法识别来源的发送动作，默认按“中风险以上策略”处理（先阻断，需用户确认后继续）。
5. 拦截后先执行检测与脱敏，再将处理后文本写回输入框并发送。

### 4.4 风险分级

1. 低风险：自动替换并提示。
2. 中风险：弹窗确认后发送。
3. 高风险：默认阻止发送，需用户手动确认放行。

### 4.5 规则类型默认映射

| 规则类型 | 默认风险等级 | 默认动作 | 用户可覆盖 |
| --- | --- | --- | --- |
| 真实姓名 | 低 | 仅提示，不自动替换 | 是 |
| 邮箱地址 | 中 | 默认部分脱敏，确认后发送 | 是 |
| 手机号码 | 中 | 默认部分脱敏，确认后发送 | 是 |
| 银行卡号 | 高 | 默认全量脱敏或阻止发送 | 是（最低不可低于中） |
| API Key | 高 | 默认全量脱敏或阻止发送 | 是（最低不可低于中） |

### 4.6 规则管理

1. 内置规则：手机号、银行卡、邮箱、常见密钥。
2. 自定义规则：支持用户添加正则、替换模板、风险等级。
3. 规则开关：支持按类型启用/禁用。
4. 自定义正则安全约束（防 ReDoS）：
   - 单条正则长度上限 `<= 256` 字符。
   - 自定义规则总数上限 `<= 100`。
   - 仅允许 flags：`g`、`i`、`m`、`u`。
   - 保存前执行安全校验，拒绝高风险模式（如灾难性回溯模式）。
   - 单条规则单次执行超时 `<= 20ms`（以 2000 字输入为基准），超时则中止该规则并记录告警。
   - 单次检测总预算 `<= 80ms`，超预算后停止执行剩余自定义规则并提示“部分规则未执行完成”。
5. 自定义规则保存前需通过“编译检查 + 示例文本试运行”。

### 4.7 站点范围

1. 首版内置白名单域名：
   - `chatgpt.com`
   - `chat.openai.com`
   - `claude.ai`
   - `gemini.google.com`
   - `chat.deepseek.com`
2. 域名匹配规则：
   - 支持精确域名（如 `claude.ai`）。
   - 支持子域通配（如 `*.example.com`）。
   - 默认仅对 `https` 页面生效。
3. iframe 策略：
   - 支持已授权域名下的 iframe 注入与拦截。
   - 对未授权跨域 iframe，不做内容注入，降级为顶层页面提示“当前子框架未覆盖”。
4. 用户可手动增加/删除匹配站点（高级设置）。

### 4.8 忽略与白名单

1. 本次忽略：仅对当前一次发送生效。
2. 会话忽略：仅对当前标签页会话生效，关闭标签页后失效。
3. 白名单规则：支持按“规则类型 + 域名”持久化放行。
4. 白名单有效期默认 `30 天`，可配置；到期自动失效。
5. 白名单记录不得保存原文，仅保存脱敏摘要或不可逆指纹。

### 4.9 本地日志与统计

1. 仅记录命中类型、命中次数、时间戳、处理动作、规则来源（内置/自定义）。
2. 不记录原文和完整敏感值。
3. 保留策略：默认仅保留最近 `30 天`。
4. 容量上限：最多 `5000` 条记录或 `5MB`（先到先触发），超过后按时间淘汰最旧数据。
5. 提供一键清空本地记录能力。

## 5. 非功能需求

1. 性能：
   - 2000 字以内文本检测耗时 `P95 <= 80ms`，`P99 <= 120ms`。
   - 主线程单次阻塞不超过 `16ms`。
2. 准确性（强规则项）：
   - 手机号：召回率 `>= 99%`，误报率 `<= 2%`。
   - 银行卡号：召回率 `>= 99%`，误报率 `<= 1%`。
   - API Key：召回率 `>= 98%`，误报率 `<= 3%`。
3. 隐私与联网策略（可验证约束）：
   - 检测与脱敏链路默认离线执行，不依赖外部服务。
   - 发送检测期间禁止上传原始输入内容、未脱敏片段、完整命中值。
   - 权限最小化：禁止申请 `<all_urls>`；`host_permissions` 仅包含白名单域名和用户手动添加域名。
   - 如启用规则更新，仅允许 HTTPS 拉取签名规则包；请求体不得包含用户输入内容。
   - 崩溃上报/遥测默认关闭；若用户开启，仅允许上传错误码、版本号、浏览器类型等元信息。
4. 兼容性：
   - 基于 WebExtensions 规范设计，覆盖 Chrome、Edge、Firefox 三类主流浏览器稳定版。
   - 每次发布需通过三类浏览器“最新稳定版 + 前一稳定版”兼容验证。
5. 可维护性：规则引擎与页面注入逻辑解耦，便于后续扩展。

## 6. 边界与风险

1. “真实姓名”天然误报率较高，MVP 默认仅提示不强制替换。
2. 各站点 DOM 结构差异大（含 iframe/shadow DOM），可能导致拦截失效，需要持续适配。
3. 代码/示例中的测试密钥可能被误判，需通过“本次忽略/会话忽略/白名单”降低干扰。
4. 用户通过截图、附件上传敏感信息，MVP 暂不覆盖该通道。
5. 未授权跨域 iframe 无法注入时，存在覆盖盲区，需显式提示用户。
6. 自定义规则配置不当可能导致漏检或误检，需要提供配置校验和回滚能力。

## 7. MVP 验收标准（量化）

1. 发送路径覆盖：在白名单站点上，`Enter`、`Ctrl/Cmd+Enter`、发送按钮、`submit/requestSubmit`、程序化发送 5 类路径拦截成功率为 `100%`。
2. IME 兼容：中文输入法合成期间不得误触发发送检查；合成结束后发送可被拦截。
3. 脱敏正确性：包含手机号 + API Key 的输入在发送前必定触发检测与脱敏，最终发送内容必须是脱敏版本。
4. 隐私验证：抓包与日志审计下，连续 100 次发送场景不得出现原始输入内容出站。
5. 性能验证：2000 字样本集下检测耗时满足 `P95 <= 80ms`、`P99 <= 120ms`。
6. 准确性验证：在不少于 `2000` 条样本（正负样本均衡）的测试集中，强规则项达到第 5 节定义指标。
7. 日志策略：超过 `30 天` 或超容量阈值后自动淘汰，清空操作可立即生效。
8. 跨浏览器兼容：Chrome、Edge、Firefox 三类浏览器中核心流程（拦截、检测、脱敏、发送）均通过回归测试。
9. 扩展禁用后，目标页面恢复原始发送行为，不引入额外报错。

## 8. 版本规划建议

1. V0.2（MVP）：多路径发送拦截、核心规则识别、脱敏发送、规则安全约束、基础设置页。
2. V0.3：更多密钥模式、上下文语义辅助识别、误报优化。
3. V0.4：团队策略下发、审计能力、企业级策略管理。

## 9. 后续输出物（开发前）

1. 技术方案：架构图、模块边界、关键流程（注入、拦截、脱敏、回写、发送）。
2. Manifest 与权限最小化设计（含 Chrome / Edge / Firefox 差异适配说明）。
3. 正则安全设计：ReDoS 防护策略、执行超时机制、异常降级方案。
4. 隐私与联网设计：数据分类分级、出站策略、可审计验证方案。
5. 测试计划：覆盖路径矩阵、准确性数据集、性能基线与跨浏览器回归方案。
6. 开发任务拆解：按里程碑和优先级拆分到可执行任务。

## 10. 上线与运维要求

### 10.1 失败兜底策略

1. 触发以下异常时必须进入失败兜底：检测超时、内容脚本注入失败、规则引擎异常、目标输入框不可写入。
2. 失败兜底默认策略：
   - 低风险规则：允许发送，并展示显著提示“本次未完成完整检测”。
   - 中风险规则：默认阻断，用户二次确认后允许发送。
   - 高风险规则：强制阻断，不提供一键放行。
3. 所有兜底事件必须记录到本地日志（仅错误码、站点、时间戳、规则类型，不含原文）。
4. 连续 3 次失败后，需向用户展示“当前站点兼容异常”并引导提交诊断信息（默认不上传，需手动确认）。

### 10.2 浏览器差异适配清单

1. 需维护 `Chrome / Edge / Firefox` 差异矩阵，至少包含：Manifest 字段差异、API 支持差异、权限提示差异、商店包要求。
2. Firefox 适配需重点验证：
   - `service worker` 生命周期差异导致的后台任务中断。
   - `declarativeNetRequest` 与相关替代能力的可用性差异。
3. 每次发布前，差异矩阵中的“高风险差异项”必须给出规避实现或降级方案。
4. 差异矩阵作为发布阻断项，缺失不得发布。

### 10.3 测试集与标注规范

1. 准确性测试集总量不少于 `2000` 条，且每个强规则类型（手机号、银行卡、API Key）正样本不少于 `300` 条，负样本不少于 `300` 条。
2. 测试样本来源需覆盖：自然文本、代码片段、日志片段、混合中英文本。
3. 标注规则需统一：命中边界、是否允许部分匹配、冲突规则优先级。
4. 每次规则更新必须跑完整回归集，并输出以下报告：召回率、误报率、耗时分位数、新增误报 Top10。
5. 测试样本不得包含真实敏感数据；如使用脱敏生产样本，需完成不可逆匿名化。

### 10.4 规则更新与安全运维

1. 规则包必须签名校验，签名失败或版本回退时拒绝加载。
2. 规则版本采用单调递增策略，禁止静默降级。
3. 必须支持“上一稳定版本一键回滚”，回滚操作不影响用户自定义规则。
4. 规则发布需支持分批灰度（建议 5% -> 20% -> 50% -> 100%），每批次观察不少于 24 小时。
5. 密钥轮换策略：
   - 签名密钥至少每 `180` 天轮换一次。
   - 轮换期间支持双公钥验证，过渡期结束后清理旧密钥。

### 10.5 发布与合规要求

1. 上架到 Chrome Web Store、Microsoft Edge Add-ons、Firefox Add-ons 前，必须完成统一隐私声明，明确“默认不上传原文”。
2. 扩展内需提供清晰的数据说明页：采集项、用途、存储位置、保留时长、用户关闭方式。
3. 遥测/崩溃上报必须默认关闭，开启操作需二次确认并可随时撤回。
4. 发布包需包含版本变更说明，标记规则变更、权限变更、潜在行为变化。
5. 发现隐私或漏拦截高危问题时，需在 `48 小时` 内发布热修复或下架问题版本。
