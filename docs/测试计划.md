# SentinelMask 测试计划（V0.2 / MVP）

## 1. 测试目标

1. 验证核心链路：拦截 -> 检测 -> 脱敏 -> 回写 -> 发送。
2. 验证质量指标：准确性、性能、隐私、兼容性达标。
3. 验证异常场景：失败兜底策略与可观测性有效。

## 2. 测试范围

1. 站点范围：`chatgpt.com`、`chat.openai.com`、`claude.ai`、`gemini.google.com`、`chat.deepseek.com`。
2. 浏览器范围：Chrome / Edge / Firefox（最新稳定版 + 前一稳定版）。
3. 规则范围：姓名、手机号、银行卡、邮箱、API Key、自定义规则。
4. 发送路径：`Enter`、`Ctrl/Cmd+Enter`、发送按钮、`submit/requestSubmit`、程序化发送。

## 3. 测试分层

## 3.1 单元测试（核心引擎）

1. 规则匹配正确性（正负样本）。
2. 脱敏策略正确性（全替换、部分保留、仅提示）。
3. 风险决策映射正确性（默认映射和用户覆盖）。
4. 自定义规则校验器（长度、flags、数量、危险模式）。
5. 执行预算控制（单条 20ms、总预算 80ms）。

## 3.2 集成测试（内容脚本 + 页面）

1. `preSendGuard` 各触发路径均能进入。
2. IME 合成期间不触发，`compositionend` 后按实际发送动作触发。
3. 回写器在 textarea/contenteditable 下行为一致。
4. 中高风险确认流程与放行流程正确。

## 3.3 E2E 测试（浏览器实测）

1. 白名单站点核心流程全通过。
2. 未授权跨域 iframe 显示降级提示。
3. 扩展禁用后站点恢复原生行为且无额外报错。

## 3.4 非功能测试

1. 性能：2000 字样本 `P95 <= 80ms`，`P99 <= 120ms`。
2. 隐私：100 次发送场景抓包不出现原始输入。
3. 容量与保留：30 天 TTL、5000 条/5MB 上限淘汰生效。

## 4. 用例矩阵（核心）

| 维度 | 子项 | 预期 |
| --- | --- | --- |
| 发送触发 | Enter | 进入 `preSendGuard`，按风险策略处理 |
| 发送触发 | Ctrl/Cmd+Enter | 进入 `preSendGuard`，按风险策略处理 |
| 发送触发 | 发送按钮点击 | 进入 `preSendGuard`，按风险策略处理 |
| 发送触发 | submit/requestSubmit | 进入 `preSendGuard`，按风险策略处理 |
| 发送触发 | 程序化 click/submit | 进入 `preSendGuard`；未知来源按中风险以上策略 |
| 输入法 | compositionstart -> compositionend | 合成期间不触发，结束后正常触发 |
| 脱敏 | 手机号/API Key 混合 | 最终发送内容必须为脱敏版本 |
| 风险 | 高风险命中 | 默认阻断，需手动确认 |
| 异常 | 引擎超时/注入失败 | 按失败兜底策略处理并落日志 |

## 5. 测试数据集规范

1. 总量不少于 `2000` 条，正负样本均衡。
2. 强规则类型（手机号、银行卡、API Key）每类：
   - 正样本不少于 `300`。
   - 负样本不少于 `300`。
3. 样本来源覆盖：自然文本、代码片段、日志片段、中英混合文本。
4. 禁止真实敏感数据，使用合成数据或不可逆匿名化数据。
5. 标注规范统一：
   - 命中边界定义。
   - 是否允许部分匹配。
   - 冲突规则优先级。

## 6. 性能测试方案

1. 基线输入：2000 字文本，含多类型敏感内容和噪声文本。
2. 指标采集：
   - 总检测耗时（P50/P95/P99）。
   - 主线程阻塞时间（单次不超过 16ms）。
3. 压测轮次：
   - 每浏览器至少 1000 次检测样本。
   - 每次规则更新后全量重跑。
4. 不达标处理：
   - 输出慢规则 TopN。
   - 降级策略：禁用高成本自定义规则并提示用户。

## 7. 隐私与安全验证

1. 抓包验证：
   - 在开启所有核心场景下执行 100 次发送。
   - 校验无原文、无未脱敏命中值出站。
2. 存储审计：
   - 校验本地存储不含原文与完整命中值。
3. 规则更新安全：
   - 验证签名失败拒绝加载。
   - 验证版本回退拒绝加载。

## 8. 跨浏览器回归策略

1. 每次发布前执行“最新稳定版 + 前一稳定版”回归。
2. 差异矩阵至少包含：
   - Manifest 字段差异。
   - API 支持差异。
   - 权限提示差异。
   - 商店包要求差异。
3. 高风险差异项必须有规避或降级方案，否则阻断发布。

## 9. 退出准入（Release Gate）

1. 发送路径覆盖成功率达到 100%。
2. 强规则准确性满足需求阈值。
3. 性能满足 `P95 <= 80ms`、`P99 <= 120ms`。
4. 隐私审计通过（100 次场景无原文出站）。
5. 跨浏览器核心流程回归全部通过。
6. 发布材料齐全（隐私声明、变更说明、差异矩阵、测试报告）。

## 10. 测试产出物

1. `准确性报告`：召回率、误报率、新增误报 Top10。
2. `性能报告`：分位数、慢规则分析、优化建议。
3. `隐私审计报告`：抓包结论、存储审计结论。
4. `兼容性报告`：三浏览器回归结果与风险清单。
