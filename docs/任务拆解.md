# SentinelMask 开发任务拆解（V0.2 / MVP）

## 1. 任务拆解原则

1. 单任务粒度控制在 `0.5-2` 人天。
2. 每个任务必须包含明确 DoD（完成定义）和验收标准。
3. 优先做“高风险 + 阻断型”任务（发送拦截链路与隐私约束）。

## 2. 里程碑规划

1. M0：工程初始化与质量基线。
2. M1：核心链路（拦截、检测、脱敏、回写、发送）。
3. M2：配置中心与安全约束（自定义规则、白名单、日志）。
4. M3：多站点适配与跨浏览器兼容。
5. M4：发布与合规准备。

## 3. Backlog（可执行任务）

| ID | 优先级 | 里程碑 | 任务 | DoD（完成定义） | 预估 | 依赖 |
| --- | --- | --- | --- | --- | --- | --- |
| T001 | P0 | M0 | 初始化扩展工程（MV3）与目录结构 | 构建可运行；content/background/options 三端可启动；CI 能跑 lint/test | 1d | - |
| T002 | P0 | M0 | 定义共享类型与错误码 | `PreSendContext`、`GuardResult`、错误码常量落地；全链路统一引用 | 0.5d | T001 |
| T003 | P0 | M0 | 建立日志与指标基础模块 | 可记录命中类型/动作/时间；不含原文；支持容量与 TTL 淘汰 | 1d | T001 |
| T004 | P0 | M1 | 实现 `preSendGuard` 主流程 | 可串联检测->脱敏->决策->回写；支持低中高风险动作 | 1.5d | T002 |
| T005 | P0 | M1 | 键盘发送拦截（Enter/Ctrl/Cmd+Enter） | 捕获阶段可拦截；IME 合成期间不触发；回归通过 | 1d | T004 |
| T006 | P0 | M1 | 按钮点击发送拦截 | 发送按钮及自定义按钮点击可进入网关 | 1d | T004 |
| T007 | P0 | M1 | 表单 `submit/requestSubmit` 拦截 | 原生与脚本触发 submit 均进入网关 | 1d | T004 |
| T008 | P0 | M1 | 程序化发送拦截（click/submit） | patch 后可覆盖程序触发路径；未知来源按中风险处理 | 1.5d | T006,T007 |
| T009 | P0 | M1 | 输入框抽象与回写器 | textarea/contenteditable 回写正确，光标与撤销行为可用 | 1d | T004 |
| T010 | P0 | M1 | 内置规则引擎（手机号/银行卡/邮箱/API Key/姓名） | 命中结构统一；银行卡含 Luhn；姓名默认仅提示 | 2d | T004 |
| T011 | P0 | M1 | 脱敏策略执行器 | 全替换/部分保留/仅提示策略可配置，默认映射符合需求 | 1d | T010 |
| T012 | P0 | M1 | ChatGPT 首站点适配器 | 在 `chatgpt.com` 全发送路径拦截成功率达到 100%（本地回归） | 1.5d | T005,T006,T007,T008,T009 |
| T013 | P0 | M1 | 中高风险确认弹窗 | 中风险确认后发送；高风险默认阻断并可手动确认 | 1d | T004,T011 |
| T014 | P0 | M2 | 设置页基础框架 | 可配置规则开关、策略映射、站点列表；持久化成功 | 1d | T001 |
| T015 | P0 | M2 | 自定义规则管理 | 新增/编辑/删除规则；校验长度、flags、数量 | 1.5d | T014 |
| T016 | P0 | M2 | 自定义规则安全校验器 | 编译检查、示例试运行、高风险模式拦截 | 1.5d | T015 |
| T017 | P0 | M2 | 自定义规则执行预算控制 | 单条 20ms、总预算 80ms；超时可中止并提示 | 1.5d | T016 |
| T018 | P0 | M2 | 忽略与白名单策略 | 本次忽略、会话忽略、规则类型+域名白名单（默认 30 天） | 1d | T014 |
| T019 | P0 | M2 | 日志页与一键清空 | 仅展示匿名字段；支持立即清空与自动淘汰验证 | 1d | T003,T014 |
| T020 | P0 | M2 | 失败兜底策略实现 | 超时/注入失败/回写失败场景按低中高策略处理并记日志 | 1d | T004,T003 |
| T021 | P1 | M3 | Claude 站点适配 | `claude.ai` 核心链路通过回归 | 1d | T012 |
| T022 | P1 | M3 | Gemini 站点适配 | `gemini.google.com` 核心链路通过回归 | 1d | T012 |
| T023 | P1 | M3 | DeepSeek 站点适配 | `chat.deepseek.com` 核心链路通过回归 | 1d | T012 |
| T024 | P1 | M3 | iframe 覆盖与降级提示 | 授权 iframe 可注入；未授权跨域 iframe 有明确提示 | 1.5d | T021,T022,T023 |
| T025 | P1 | M3 | Firefox 差异适配 | 处理 SW 生命周期差异，核心流程稳定 | 1.5d | T021,T022,T023 |
| T026 | P1 | M3 | Edge 差异验证 | 权限提示与商店包要求验证通过 | 1d | T021,T022,T023 |
| T027 | P1 | M4 | 规则更新能力（可开关） | HTTPS 拉取、签名校验、版本单调递增、回滚能力可用 | 2d | T016,T017 |
| T028 | P1 | M4 | 隐私说明页与数据说明页 | 明确采集项、用途、保留时长、关闭方式 | 1d | T014 |
| T029 | P1 | M4 | 发布流水线与多商店打包 | Chrome/Edge/Firefox 打包脚本可复现，含变更说明模板 | 1.5d | T025,T026 |
| T030 | P0 | M4 | 发布阻断清单与验收报告 | 差异矩阵、准确性报告、性能报告、隐私审计报告齐全 | 1d | 全部核心任务 |

## 4. 开发顺序建议（两周节奏示例）

1. 第 1 周：M0 + M1（必须先打通 ChatGPT 闭环）。
2. 第 2 周前半：M2（设置、自定义规则安全约束、日志）。
3. 第 2 周后半：M3（多站点与浏览器兼容），并并行准备 M4 材料。

## 5. 每日执行模板

1. 当日目标：限定 2-4 个任务 ID。
2. 产出：PR + 测试结果 + 风险说明。
3. 阻塞项：明确“可自解/需协作”与预计解除时间。
4. 质量门禁：单测通过、关键回归通过、无隐私红线问题。

## 6. 关键风险与应对

1. DOM 变化导致拦截失效。
   - 应对：站点适配器分层，加入 smoke 回归和快速热修复入口。
2. 自定义正则导致性能抖动。
   - 应对：执行预算、超时中断、静态风险校验。
3. 跨浏览器行为差异。
   - 应对：维护差异矩阵，M3 前置验证，不达标不发布。
